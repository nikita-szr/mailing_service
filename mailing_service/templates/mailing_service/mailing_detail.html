{% load static %}

<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Детали рассылки</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
</head>
<body>
    <div class="container my-4">
        <h1>Детали рассылки</h1>

        {% if messages %}
            <ul class="alert-list">
                {% for message in messages %}
                    <li class="alert {{ message.tags }}">{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <p><strong>Статус:</strong> {{ mailing.get_status_display }}</p>
        <p><strong>Дата и время первой отправки:</strong> {{ mailing.start_datetime }}</p>
        <p><strong>Дата и время окончания отправки:</strong> {{ mailing.end_datetime }}</p>
        <p><strong>Сообщение:</strong> {{ mailing.message.subject }}</p>
        <p><strong>Тело сообщения:</strong> {{ mailing.message.body }}</p>

        <h2 class="mt-4">Получатели рассылки</h2>
        <ul class="list-group mb-4">
            {% for recipient in mailing.recipients.all %}
                <li class="list-group-item">{{ recipient.full_name }} ({{ recipient.email }})</li>
            {% empty %}
                <li class="list-group-item">Получателей нет.</li>
            {% endfor %}
        </ul>

        <h2>Попытки рассылки</h2>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Дата и время попытки</th>
                    <th>Статус</th>
                    <th>Ответ сервера</th>
                </tr>
            </thead>
            <tbody>
                {% for attempt in mailing.attempts.all %}
                    <tr>
                        <td>{{ attempt.attempt_datetime }}</td>
                        <td>{{ attempt.get_status_display }}</td>
                        <td>{{ attempt.server_response }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="3">Попыток не найдено</td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        {% if user.is_authenticated and user.is_staff or mailing.user == user %}
            <form action="{% url 'mailing_service:mailing_send' mailing.pk %}" method="post" class="mt-3">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary">Отправить рассылку</button>
            </form>
        {% endif %}

        <a href="{% url 'mailing_service:mailing_update' mailing.pk %}" class="btn btn-secondary mt-3">Редактировать</a>
        <a href="{% url 'mailing_service:mailing_list' %}" class="btn btn-link mt-3">Назад к списку</a>
    </div>
</body>
</html>